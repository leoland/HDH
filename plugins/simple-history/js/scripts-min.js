var simple_history=function($){var t=window.ajaxurl;t+=t.indexOf("?")>=0?"&":"?",t+="action=simple_history_api";var i=function(t){if("object"==typeof t){var i="";_.each(t,function(t,o){i+=o+": "+t+"\n"}),t=i}$(".SimpleHistoryLogitems__debug").append("<br>"+t)},o=Backbone.Collection.extend({initialize:function(t,i){this.mainView=i.mainView,$(document).trigger("SimpleHistory:logRowsCollectionInitialize")},reload:function(){this.trigger("reload"),$(document).trigger("SimpleHistory:logRowsCollectionReload");var i=this.mainView.$el.data("pagerSize");this.url=t+"&type=overview&format=html",this.url+="&posts_per_page="+i,this.api_args=null,this.max_id=null,this.min_id=null,this.pages_count=null,this.total_row_count=null,this.page_rows_from=null,this.page_rows_to=null,this.max_id_first_page=null;var o=this,e={paged:1};this.trigger("before_fetch",this,e),this.fetch({reset:!0,data:e,error:function(t,i,o){t.trigger("reloadError",[i,o]),$(document).trigger("SimpleHistory:logRowsCollectionReloadError",[i,o])},success:function(t,i,o){t.trigger("reloadDone",[i,o]),$(document).trigger("SimpleHistory:logRowsCollectionReloadDone",[i,o])}})},parse:function(t,i){if(!t||!t.data)return void alert("Error in response, could not parse");this.api_args=t.data.api_args,this.max_id=t.data.max_id,this.min_id=t.data.min_id,this.pages_count=t.data.pages_count,this.total_row_count=t.data.total_row_count,this.page_rows_from=t.data.page_rows_from,this.page_rows_to=t.data.page_rows_to,this.max_id_first_page||(this.max_id_first_page=this.max_id,$(document).trigger("SimpleHistory:logRowsCollectionFirstLoad"),$(".SimpleHistory__waitingForFirstLoad").addClass("SimpleHistory__waitingForFirstLoad--isLoaded"),$("body").addClass("SimpleHistory--isLoaded"));var o=[];return _.each(t.data.log_rows,function(t){o.push({html:t})}),o}}),e=Backbone.Collection.extend({initialize:function(i,o){this.url=t+"&type=occasions&format=html",this.fetch({reset:!0,data:{logRowID:o.logRowID,occasionsID:o.occasionsID,occasionsCount:o.occasionsCount,occasionsCountMaxReturn:o.occasionsCountMaxReturn}})},parse:function(t,i){this.api_args=t.data.api_args,this.max_id=t.data.max_id,this.min_id=t.data.min_id,this.pages_count=t.data.pages_count,this.total_row_count=t.data.total_row_count,this.page_rows_from=t.data.page_rows_from,this.page_rows_to=t.data.page_rows_to;var o=[];return _.each(t.data.log_rows,function(t){o.push({html:t})}),o}}),s=Backbone.View.extend({initialize:function(){var t=this.attributes.logRow.data("rowId"),i=this.attributes.logRow.data("occasionsCount"),o=15;this.occasionsCountMaxReturn=o;var s=this.attributes.logRow.data("occasionsId");this.attributes.logRow.addClass("SimpleHistoryLogitem--occasionsOpening"),this.logRows=new e([],{logRow:this.attributes.logRow,logRowID:t,occasionsID:s,occasionsCount:i,occasionsCountMaxReturn:o}),this.logRows.on("reset",this.render,this),this.logRows.on("reset",function(){$(document).trigger("SimpleHistory:logRowsCollectionOccasionsLoaded")},this)},render:function(){var t=$([]);this.logRows.each(function(i){var o=$(i.get("html"));o.addClass("SimpleHistoryLogitem--occasion"),t=t.add(o)});var i=this.attributes.logRow.data("occasionsCount");if(i>this.occasionsCountMaxReturn){var o=wp.template("simple-history-occasions-too-many");t=t.add(o({occasionsCount:i,occasionsCountMaxReturn:this.occasionsCountMaxReturn}))}this.$el.html(t),this.attributes.logRow.removeClass("SimpleHistoryLogitem--occasionsOpening").addClass("SimpleHistoryLogitem--occasionsOpened"),this.$el.addClass("haveOccasionsAdded")}}),a=Backbone.Model.extend({url:t+"&type=single&format=html"}),n=Backbone.View.extend({initialize:function(t){this.model.fetch({data:{id:this.model.get("id")}}),this.template=$("#tmpl-simple-history-logitems-modal").html(),this.show(),this.listenTo(this.model,"change",this.render);var i=this;$(document).on("keydown.simplehistory.modal",function(t){27==t.keyCode&&i.close()})},events:{"click .SimpleHistory-modal__background":"close","click .SimpleHistory-modal__contentClose":"close"},show:function(){var t=$(".SimpleHistory-modal");t.length||(t=$(this.template),t.appendTo("body")),this.setElement(t);var i=t.find(".SimpleHistory-modal__content");i.addClass("SimpleHistory-modal__content--enter");var o=i.get(0).offsetHeight;i.addClass("SimpleHistory-modal__content--enter-active")},close:function(){var t=this.$el.find(".SimpleHistory-modal__content");t.addClass("SimpleHistory-modal__content--leave");var i=t.get(0).offsetHeight;t.addClass("SimpleHistory-modal__content--leave-active"),this.$el.addClass("SimpleHistory-modal__leave-active");var o=this;setTimeout(function(){o.$el.remove(),$(document).off("keyup.simplehistory.modal"),o.remove(),Backbone.history.navigate("overview")},400)},render:function(){var t=this.$el.find(".SimpleHistory-modal__contentInner"),i=this.model.get("data").log_rows[0];t.html(i)}}),r=Backbone.View.extend({initialize:function(){this.collection.on("reset",this.render,this),this.collection.on("reload",this.onReload,this),this.collection.on("reloadDone",this.onReloadDone,this),this.collection.on("reloadError",this.onReloadError,this),this.collection.on("reset",function(){$(document).trigger("SimpleHistory:logLoaded")},this)},onReloadError:function(t){var i=t[0];if(i&&i.responseText){$("html").removeClass("SimpleHistory-isLoadingPage"),$(".SimpleHistory__waitingForFirstLoad").addClass("SimpleHistory__waitingForFirstLoad--isLoaded");var o=this.collection.mainView.$el;o.addClass("SimpleHistory--ajaxHasErrors");var e="SimpleHistoryLogitems__ajaxError";o.find("."+e).remove();var s=$("<div />").html("<div class='SimpleHistoryLogitems__ajaxError__infoMessage'>"+simple_history_script_vars.ajaxLoadError+"</div>"+i.responseText).addClass(e).appendTo(o.find(".SimpleHistoryLogitems__above"))}},onReload:function(){$(document).trigger("SimpleHistory:logReloadStart"),$("html").addClass("SimpleHistory-isLoadingPage")},onReloadDone:function(){$("html").removeClass("SimpleHistory-isLoadingPage");var t=this.collection.mainView.$el;if(t.find(".SimpleHistoryLogitems__ajaxError").remove(),t.removeClass("SimpleHistory--hasNoHits"),!this.collection.length){t.addClass("SimpleHistory--hasNoHits");var i="SimpleHistoryLogitems__noHits";t.find("."+i).remove();var o=$("<div />").html(simple_history_script_vars.logNoHits).addClass(i).appendTo(t.find(".SimpleHistoryLogitems__above"))}},events:{"click .SimpleHistoryLogitem__occasions a":"showOccasions","click .SimpleHistoryLogitem__permalink":"permalink"},permalink:function(t){if(t.metaKey)return!0;t.preventDefault();var i=$(t.target),o=i.closest(".SimpleHistoryLogitem"),e=o.data("rowId");Backbone.history.navigate("item/"+e,{trigger:!0})},showOccasions:function(t){t.preventDefault();var i=$(t.target),o=i.closest(".SimpleHistoryLogitem"),e=$("<li class='SimpleHistoryLogitem__occasionsItemsWrap'><ul class='SimpleHistoryLogitem__occasionsItems'/></li>");o.after(e),this.occasionsView=new s({el:e.find(".SimpleHistoryLogitem__occasionsItems"),attributes:{logRow:o}})},render:function(){var t="";this.collection.each(function(i){t+=i.get("html")}),this.$el.html(t),this.trigger("renderDone")}}),l=Backbone.View.extend({initialize:function(){$(document).keydown({view:this},this.keyboardNav),this.collection.on("reset",this.render,this)},events:{"click .SimpleHistoryPaginationLink":"navigateArrow","keyup .SimpleHistoryPaginationCurrentPage":"navigateToPage",keydown:"keydown"},keyboardNav:function(t){if(!$(".SimpleHistory-modal").length&&$(".dashboard_page_simple_history_page").length){var i=$(t.target);if(!i.is("input")){var o;37==t.keyCode?o=+t.data.view.collection.api_args.paged-1:39==t.keyCode&&(o=+t.data.view.collection.api_args.paged+1),o&&t.data.view.fetchPage(o)}}},navigateToPage:function(t){if(13==t.keyCode){var i=$(t.target),o=parseInt(i.val());o<1&&(o=1),o>this.collection.pages_count&&(o=this.collection.pages_count),this.fetchPage(o)}},navigateArrow:function(t){t.preventDefault();var i=$(t.target);if(!i.is(".disabled")){var o=i.data("direction"),e;switch(o){case"first":e=1;break;case"last":e=this.collection.pages_count;break;case"prev":e=+this.collection.api_args.paged-1;break;case"next":e=+this.collection.api_args.paged+1}this.fetchPage(e)}},fetchPage:function(t){$(document).trigger("SimpleHistory:logReloadStart"),$("html").addClass("SimpleHistory-isLoadingPage");var i={paged:t,max_id_first_page:this.collection.max_id_first_page};this.collection.trigger("before_fetch",this.collection,i),this.collection.fetch({reset:!0,data:i,success:function(){$("html").removeClass("SimpleHistory-isLoadingPage")}}),$("html, body").animate({scrollTop:this.attributes.mainView.$el.offset().top-85},350)},render:function(){var t=wp.template("simple-history-logitems-pagination");this.$el.html(t({min_id:this.collection.min_id,max_id:this.collection.max_id,pages_count:this.collection.pages_count,total_row_count:this.collection.total_row_count,page_rows_from:this.collection.page_rows_from,page_rows_to:this.collection.page_rows_to,api_args:this.collection.api_args,strings:simple_history_script_vars.pagination}))}}),c=Backbone.View.extend({el:".SimpleHistoryGui",initialize:function(){this.addNeededElements()},manualInitialize:function(){this.$el.length&&(this.logRouter=new d,Backbone.history.start(),this.logRowsCollection=new o([],{mainView:this}),this.rowsView=new r({el:this.$el.find(".SimpleHistoryLogitems"),collection:this.logRowsCollection}),$(document).trigger("SimpleHistory:mainViewInitBeforeLoadRows"),this.logRowsCollection.reload(),$(document).trigger("SimpleHistory:mainViewInitAfterLoadRows"),this.paginationView=new l({el:this.$el.find(".SimpleHistoryLogitems__pagination"),collection:this.logRowsCollection,attributes:{mainView:this}}),$(document).trigger("SimpleHistory:init"))},addNeededElements:function(){var t=$("#tmpl-simple-history-base").html();this.$el.html(t)}}),d=Backbone.Router.extend({routes:{"item/:number":"item","*default":"default"},item:function(t){var i=new a({id:t}),o=new n({model:i})},default:function(){return!1}}),m=new c;return $(document).ready(function(){m.manualInitialize()}),m}(jQuery);jQuery(".js-SimpleHistory-Settings-ClearLog").on("click",function(t){confirm(simple_history_script_vars.settingsConfirmClearLog)||t.preventDefault()}),function($){function t(){$(".SimpleHistoryLogitem__when time").timeago()}var i=$(document);i.on("SimpleHistory:logLoaded",t),i.on("SimpleHistory:logRowsCollectionOccasionsLoaded",t)}(jQuery);